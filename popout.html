<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ´ å½ˆå‡ºè¦–çª—</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* å½ˆå‡ºé é¢å°ˆç”¨æ¨£å¼ */
        body {
            padding: 0;
            margin: 0;
        }

        .popout-page {
            min-height: 100vh;
            padding: var(--spacing-md);
        }

        .popout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--radius-lg);
        }

        .popout-header h1 {
            margin: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--success-glow);
            color: var(--success);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
        }

        .sync-indicator.syncing {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .popout-content {
            min-height: 50vh;
        }

        /* å…§å®¹å€åŸŸå¡ç‰‡æ¨£å¼èª¿æ•´ */
        .popout-content .card {
            margin-bottom: 0;
        }

        .popout-content .chart-card {
            height: auto;
        }

        .popout-content .chart-container {
            height: 500px;
        }

        .popout-content .table-container {
            max-height: 70vh;
            overflow: auto;
        }

        .popout-content .stats-grid {
            margin-bottom: 0;
        }

        /* OBS æ¨¡å¼ - é€æ˜èƒŒæ™¯ */
        body.obs-mode {
            background: transparent !important;
        }

        body.obs-mode .popout-page {
            background: transparent !important;
            padding: var(--spacing-sm);
        }

        body.obs-mode .popout-header {
            display: none !important;
        }

        body.obs-mode .card {
            background: rgba(10, 10, 20, 0.85) !important;
            backdrop-filter: blur(10px);
        }

        body.obs-mode .stats-grid {
            gap: var(--spacing-sm);
        }

        body.obs-mode .stat-card {
            padding: var(--spacing-sm);
        }

        /* OBS ç²¾ç°¡æ¨¡å¼ - åªé¡¯ç¤ºé—œéµæ•¸æ“š */
        body.obs-compact .popout-page {
            padding: var(--spacing-xs);
        }

        body.obs-compact .card {
            border-radius: var(--radius-md);
        }

        body.obs-compact .table-container {
            max-height: 50vh;
        }

        body.obs-compact th,
        body.obs-compact td {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.9rem;
        }

        /* ç¸®å°æ¬„ä½è¨­å®š Modal (30% smaller) */
        #column-settings-modal .modal-content {
            transform: scale(0.7);
            transform-origin: center center;
            width: 800px;
            /* Force wider width to fit more columns */
            max-width: 95vw;
        }
    </style>
</head>

<body>
    <div class="popout-page">
        <!-- é é¢æ¨™é¡Œ (OBS æ¨¡å¼ä¸‹éš±è—) -->
        <header class="popout-header">
            <h1 id="popout-title">è¼‰å…¥ä¸­...</h1>
            <div class="sync-indicator" id="sync-indicator">
                <span>ğŸ”„</span>
                <span data-i18n="text_synced">å·²åŒæ­¥</span>
            </div>
            <button id="toggle-simple-stats-btn" class="btn btn-secondary btn-sm" style="display: none;">
                ğŸ“‹ <span data-i18n="btn_simple_display">ç°¡æ˜“é¡¯ç¤º</span>
            </button>
        </header>

        <!-- å‹•æ…‹å…§å®¹å€ -->
        <div class="popout-content" id="popout-content">
            <!-- æ ¹æ“š block åƒæ•¸å‹•æ…‹æ¸²æŸ“ -->
        </div>
    </div>

    <!-- æ¬„ä½è¨­å®š Modal -->
    <div id="column-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal_column_settings_title">æ¬„ä½é¡¯ç¤ºè¨­å®š</h3>
                <button class="modal-close" id="close-column-modal-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row-height-settings">
                    <label data-i18n="label_row_height">è¡Œè·è¨­å®š</label>
                    <div class="btn-group" id="row-height-options">
                        <button class="btn btn-sm btn-ghost" data-height="slim" data-i18n="opt_row_slim">ç·Šæ¹Š</button>
                        <button class="btn btn-sm btn-ghost" data-height="normal" data-i18n="opt_row_normal">æ¨™æº–</button>
                        <button class="btn btn-sm btn-ghost" data-height="spacious"
                            data-i18n="opt_row_spacious">å¯¬é¬†</button>
                    </div>
                </div>
                <hr style="margin: var(--spacing-md) 0; border: none; border-top: 1px solid var(--border-color);">
                <div id="column-checkbox-list" class="column-toggles-grid">
                    <!-- å‹•æ…‹æ¸²æŸ“æ¬„ä½å‹¾é¸æ¡† -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="reset-columns-btn" class="btn btn-ghost" data-i18n="btn_reset_default"
                    style="margin-right: auto;">æ¢å¾©é è¨­</button>
                <button id="confirm-columns-btn" class="btn btn-primary" data-i18n="btn_save_changes">å¥—ç”¨è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯å°è©±æ¡† (Modal) -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal_edit_title">ç·¨è¼¯ç´€éŒ„</h3>
                <button id="close-edit-modal-btn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="edit-battle-date" data-i18n="label_date">ğŸ“… å°æˆ°æ—¥æœŸ</label>
                            <input type="date" id="edit-battle-date">
                        </div>
                        <div class="form-group">
                            <label for="edit-my-deck" data-i18n="label_my_deck">ğŸ´ å·±æ–¹ç‰Œçµ„</label>
                            <input type="text" id="edit-my-deck" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-opponent-deck" data-i18n="label_opponent_deck">ğŸ´ å°æ‰‹ç‰Œçµ„</label>
                            <input type="text" id="edit-opponent-deck" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-turn-order" data-i18n="label_turn_order">ğŸ”„ å…ˆå¾Œæ‰‹</label>
                            <select id="edit-turn-order">
                                <option value="" data-i18n="opt_not_selected">æœªé¸æ“‡</option>
                                <option value="å…ˆæ‰‹" data-i18n="opt_first">å…ˆæ‰‹</option>
                                <option value="å¾Œæ‰‹" data-i18n="opt_second">å¾Œæ‰‹</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-result" data-i18n="label_result">ğŸ† å‹è² </label>
                            <select id="edit-result">
                                <option value="" data-i18n="opt_not_selected">æœªé¸æ“‡</option>
                                <option value="å‹åˆ©" data-i18n="opt_win">å‹åˆ©</option>
                                <option value="æ•—åŒ—" data-i18n="opt_lose">æ•—åŒ—</option>
                                <option value="å¹³æ‰‹" data-i18n="opt_draw">å¹³æ‰‹</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-score" data-i18n="label_score">ğŸ“Š ç•¶å‰åˆ†æ•¸</label>
                            <input type="number" id="edit-score">
                        </div>
                        <div class="form-group">
                            <label for="edit-misplay" data-i18n="label_misplay">âš ï¸ æ¸£æ“ç­‰ç´š</label>
                            <select id="edit-misplay">
                                <option value="" data-i18n="opt_not_selected">æœªé¸æ“‡</option>
                                <option value="ç„¡" data-i18n="opt_none">ç„¡</option>
                                <option value="è¼•åº¦" data-i18n="opt_light">è¼•åº¦</option>
                                <option value="ä¸­ç­‰" data-i18n="opt_medium">ä¸­ç­‰</option>
                                <option value="åš´é‡" data-i18n="opt_severe">åš´é‡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-misplay-note" data-i18n="label_misplay_note">ğŸ“ æ¸£æ“å‚™è¨»</label>
                            <input type="text" id="edit-misplay-note">
                        </div>
                        <div class="form-group">
                            <label for="edit-game-name" data-i18n="label_game_name">ğŸ® éŠæˆ²åç¨±</label>
                            <input type="text" id="edit-game-name">
                        </div>
                        <div class="form-group">
                            <label for="edit-notes" data-i18n="label_notes">ğŸ’¬ å‚™è¨»</label>
                            <input type="text" id="edit-notes">
                        </div>
                    </div>
                    <div id="edit-custom-fields-container" class="custom-fields-container"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancel-edit-btn" class="btn btn-ghost" data-i18n="btn_cancel">å–æ¶ˆ</button>
                <button id="confirm-edit-btn" class="btn btn-primary" data-i18n="btn_save_changes">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèª Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3 data-i18n="modal_delete_title">ç¢ºèªåˆªé™¤</h3>
                <button id="close-delete-modal-btn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                <p data-i18n="modal_delete_confirm">ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
            </div>
            <div class="modal-footer">
                <button id="cancel-delete-btn" class="btn btn-ghost" data-i18n="btn_cancel">å–æ¶ˆ</button>
                <button id="confirm-delete-btn" class="btn btn-danger" data-i18n="btn_confirm_delete">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥é¸æ“‡ Modal -->
    <div id="import-choice-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal_import_title">åŒ¯å…¥é¸é …</h3>
                <button class="modal-close" id="close-import-modal-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p data-i18n="modal_import_desc">è«‹é¸æ“‡åŒ¯å…¥æ¨¡å¼ï¼š</p>
                <div class="import-options">
                    <button id="import-append-btn" class="btn btn-primary import-option-btn">
                        <span class="icon">â•</span>
                        <div class="text">
                            <span class="title" data-i18n="btn_import_append">åŠ å…¥ç¾æœ‰è³‡æ–™</span>
                            <span class="desc" data-i18n="desc_import_append">ä¿ç•™ç›®å‰ç´€éŒ„ï¼Œæ–°å¢åŒ¯å…¥çš„è³‡æ–™</span>
                        </div>
                    </button>
                    <button id="import-replace-btn" class="btn btn-danger import-option-btn">
                        <span class="icon">ğŸ“‚</span>
                        <div class="text">
                            <span class="title" data-i18n="btn_import_replace">é–‹å•Ÿé¸æ“‡è³‡æ–™</span>
                            <span class="desc" data-i18n="desc_import_replace">æ¸…ç©ºç›®å‰ç´€éŒ„ï¼Œåƒ…è¼‰å…¥åŒ¯å…¥çš„è³‡æ–™</span>
                        </div>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-import-btn" class="btn btn-ghost" data-i18n="btn_cancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- JavaScript æ¨¡çµ„ -->
    <script src="modules/i18n.js"></script>
    <script src="modules/dataManager.js"></script>
    <script src="modules/syncManager.js"></script>
    <script src="modules/chartManager.js"></script>
    <script src="modules/tableManager.js"></script>
    <script src="modules/searchManager.js"></script>
    <script>
        /**
         * å½ˆå‡ºé é¢æ§åˆ¶å™¨
         */
        (function () {
            'use strict';

            // å¾ URL å–å¾—åƒæ•¸
            const params = new URLSearchParams(window.location.search);
            const blockId = params.get('block');
            const lang = params.get('lang') || 'zh-TW';
            const obsMode = params.get('obs') === '1' || params.get('obs') === 'true';
            const obsCompact = params.get('compact') === '1' || params.get('compact') === 'true';

            // å€å¡Šè¨­å®š
            const blockConfig = {
                'form-card': {
                    title: 'header_add_record',
                    icon: 'â•',
                    render: renderFormCard
                },
                'table-card-main': {
                    title: 'header_record_table',
                    icon: 'ğŸ“‹',
                    render: renderTableCard
                },
                'search-card': {
                    title: 'header_search_filters',
                    icon: 'ğŸ”',
                    render: renderSearchCard
                },
                'score-chart-card': {
                    title: 'header_score_trend',
                    icon: 'ğŸ“ˆ',
                    render: renderScoreChart
                },
                'deck-chart-card': {
                    title: 'header_deck_dist',
                    icon: 'ğŸ¥§',
                    render: renderDeckChart
                },
                'stats-grid-wrapper': {
                    title: 'header_stats',
                    icon: 'ğŸ“Š',
                    render: renderStatsGrid
                },
                'search-results-card': {
                    title: 'header_search_results',
                    icon: 'ğŸ“‹',
                    render: renderSearchResults
                }
            };

            /**
             * æ‡‰ç”¨è¡¨æ ¼è¡Œè·è¨­å®š
             */
            function applyRowHeight() {
                const columnSettings = DataManager.getColumnSettings() || {};
                const rowHeight = columnSettings.rowHeight || 'slim';

                // ç§»é™¤æ‰€æœ‰è¡Œè·é¡åˆ¥
                document.body.classList.remove('row-height-slim', 'row-height-normal', 'row-height-spacious');

                // å¥—ç”¨æ–°çš„è¡Œè·é¡åˆ¥
                switch (rowHeight) {
                    case 'slim':
                        document.body.classList.add('row-height-slim');
                        document.documentElement.style.setProperty('--table-padding-y', '0.35rem');
                        break;
                    case 'normal':
                        document.body.classList.add('row-height-normal');
                        document.documentElement.style.setProperty('--table-padding-y', '0.75rem');
                        break;
                    case 'spacious':
                        document.body.classList.add('row-height-spacious');
                        document.documentElement.style.setProperty('--table-padding-y', '1.25rem');
                        break;
                }
            }

            /**
             * åˆå§‹åŒ–
             */
            function init() {
                // è¨­å®š OBS æ¨¡å¼
                if (obsMode) {
                    document.body.classList.add('obs-mode');
                }
                if (obsCompact) {
                    document.body.classList.add('obs-compact');
                }

                // è¨­å®šèªè¨€
                if (lang) {
                    localStorage.setItem('cardBattleLanguage', lang);
                }
                i18n.init();

                // å¦‚æœ URL æŒ‡å®šé¡¯ç¤ºæ¨¡å¼ï¼Œè¨­å®š localStorage (å„ªå…ˆæ–¼ç¾æœ‰è¨­å®š)
                if (params.has('simple') && blockId === 'stats-grid-wrapper') {
                    const isSimple = params.get('simple') === '1' || params.get('simple') === 'true';
                    localStorage.setItem('statsDisplayMode', isSimple ? 'simple' : 'standard');
                }

                // æ‡‰ç”¨è¡Œè·è¨­å®š
                applyRowHeight();

                // åˆå§‹åŒ–åŒæ­¥
                SyncManager.init();
                subscribeToSync();

                // æ¸²æŸ“å€å¡Š
                renderBlock();

                // æ›´æ–°é é¢æ¨™é¡Œ
                updateTitle();

                // ç¶å®šæ¬„ä½è¨­å®š Modal äº‹ä»¶
                bindColumnSettingsEvents();
            }

            /**
             * ç¶å®šæ¬„ä½è¨­å®š Modal äº‹ä»¶
             */
            function bindColumnSettingsEvents() {
                const closeBtn = document.getElementById('close-column-modal-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        const modal = document.getElementById('column-settings-modal');
                        if (modal) modal.classList.remove('active');
                    });
                }

                const confirmBtn = document.getElementById('confirm-columns-btn');
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', () => {
                        if (typeof TableManager !== 'undefined' && TableManager.saveColumnSettings) {
                            TableManager.saveColumnSettings();
                        }
                    });
                }

                const resetBtn = document.getElementById('reset-columns-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        if (typeof TableManager !== 'undefined' && TableManager.resetColumnSettings) {
                            TableManager.resetColumnSettings();
                        }
                    });
                }

                // è¡Œè·è¨­å®šæŒ‰éˆ•
                const rowHeightBtns = document.querySelectorAll('#row-height-options .btn');
                rowHeightBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const height = btn.dataset.height;
                        // æ›´æ–° UI é¸å–ç‹€æ…‹
                        rowHeightBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                });

                // é»æ“Š Modal å¤–éƒ¨é—œé–‰
                window.addEventListener('click', (e) => {
                    const modal = document.getElementById('column-settings-modal');
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            }

            /**
             * æ›´æ–°é é¢æ¨™é¡Œ
             */
            function updateTitle() {
                const config = blockConfig[blockId];
                if (config) {
                    document.getElementById('popout-title').textContent = i18n.get(config.title);
                    document.title = `ğŸ´ ${i18n.get(config.title)}`;
                }

                // æ›´æ–°ç°¡æ˜“é¡¯ç¤ºæŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
                updateSimpleStatsButton(blockId);
            }

            /**
             * è¨‚é–±åŒæ­¥äº‹ä»¶
             */
            function subscribeToSync() {
                SyncManager.subscribe((message) => {
                    const indicator = document.getElementById('sync-indicator');
                    indicator.classList.add('syncing');

                    switch (message.type) {
                        case SyncManager.EventTypes.RECORD_ADDED:
                        case SyncManager.EventTypes.RECORD_UPDATED:
                        case SyncManager.EventTypes.RECORD_DELETED:
                        case SyncManager.EventTypes.RECORDS_IMPORTED:
                        case SyncManager.EventTypes.FULL_SYNC:
                            renderBlock(message.data?.records);
                            break;

                        case SyncManager.EventTypes.SEARCH_FILTERS_CHANGED:
                            // ä¸»é é¢æœå°‹æ¢ä»¶è®Šæ›´ - æ ¹æ“šå½ˆå‡ºè¦–çª—é¡å‹æ›´æ–°
                            handleSearchFiltersChanged();
                            break;

                        case SyncManager.EventTypes.SETTINGS_CHANGED:
                            // æ‡‰ç”¨è¨­å®š (åŒ…å«è¡Œè·ã€å‚™è¨»é¡¯ç¤ºã€æ‰¹æ¬¡æ¨¡å¼ã€æ¬„ä½è¨­å®š)
                            applyRowHeight();

                            // å°æ–¼æœå°‹çµæœè¦–çª—ï¼Œåªé‡æ–°æ¸²æŸ“è¡¨æ ¼å…§å®¹è€Œéæ•´å€‹å€å¡Š
                            if (blockId === 'search-results-card') {
                                // åŒæ­¥æ¸£æ“å‚™è¨»é¡¯ç¤ºç‹€æ…‹
                                if (message.data && message.data.isMisplayNotesVisible !== undefined) {
                                    isPopoutMisplayNotesVisible = message.data.isMisplayNotesVisible;
                                    const btn = document.getElementById('search-toggle-misplay-notes-btn');
                                    if (btn) {
                                        btn.textContent = isPopoutMisplayNotesVisible ?
                                            (i18n.get('btn_hide_misplay_notes') || 'éš±è—æ¸£æ“å‚™è¨»') :
                                            (i18n.get('btn_show_misplay_notes') || 'é¡¯ç¤ºæ¸£æ“å‚™è¨»');
                                    }
                                }

                                // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼ˆä½¿ç”¨ localStorage ä¸­çš„éæ¿¾çµæœï¼‰
                                let searchResults = [];
                                try {
                                    const stored = localStorage.getItem('cardBattleSearchResults');
                                    if (stored) {
                                        searchResults = JSON.parse(stored);
                                    }
                                } catch (e) {
                                    console.error('Failed to load search results:', e);
                                }
                                renderSearchResultsTable(searchResults);
                            } else {
                                renderBlock();
                            }
                            break;


                        case SyncManager.EventTypes.LANGUAGE_CHANGED:
                            i18n.setLang(message.data.lang);
                            updateTitle();
                            renderBlock();
                            break;
                    }

                    setTimeout(() => {
                        indicator.classList.remove('syncing');
                    }, 500);
                });

                // è«‹æ±‚åˆå§‹åŒæ­¥
                SyncManager.requestFullSync();
            }

            /**
             * è™•ç†æœå°‹æ¢ä»¶è®Šæ›´äº‹ä»¶
             */
            function handleSearchFiltersChanged() {
                // å¦‚æœæ˜¯æœå°‹çµæœè¦–çª—ï¼ŒåŸ·è¡Œæœå°‹éæ¿¾
                if (blockId === 'search-results-card') {
                    renderSearchResults();
                } else {
                    // å…¶ä»–ä¾è³´æœå°‹çµæœçš„è¦–çª— (çµ±è¨ˆã€åœ–è¡¨)
                    let searchResults = [];
                    try {
                        const stored = localStorage.getItem('cardBattleSearchResults');
                        if (stored) {
                            searchResults = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.error('ç„¡æ³•è®€å–æœå°‹çµæœ:', e);
                        return;
                    }

                    switch (blockId) {
                        case 'stats-grid-wrapper':
                            renderStatsGrid(searchResults);
                            break;
                        case 'score-chart-card':
                            renderScoreChart(searchResults);
                            break;
                        case 'deck-chart-card':
                            renderDeckChart(searchResults);
                            break;
                    }
                }
            }


            /**
             * æ¸²æŸ“å€å¡Š
             * @param {Array} providedRecords - å¤–éƒ¨æä¾›çš„ç´€éŒ„åˆ—è¡¨ï¼ˆç”¨æ–¼åŒæ­¥ï¼‰
             */
            function renderBlock(providedRecords = null) {
                const config = blockConfig[blockId];
                if (!config) {
                    document.getElementById('popout-content').innerHTML = `
                        <div class="card" style="padding: 2rem; text-align: center;">
                            <p>âŒ æ‰¾ä¸åˆ°å€å¡Š: ${blockId}</p>
                        </div>
                    `;
                    return;
                }
                config.render(providedRecords);
            }

            /**
             * æ¸²æŸ“ï¼šæ–°å¢ç´€éŒ„è¡¨å–®
             */
            function renderFormCard() {
                document.getElementById('popout-content').innerHTML = `
                    <div class="card">
                        <form id="popout-record-form" class="record-form" style="padding: var(--spacing-lg);">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>${i18n.get('label_date')}</label>
                                    <input type="date" id="popout-battle-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>${i18n.get('label_my_deck')}</label>
                                    <input type="text" id="popout-my-deck" placeholder="${i18n.get('ph_deck_name')}" required>
                                </div>
                                <div class="form-group">
                                    <label>${i18n.get('label_opponent_deck')}</label>
                                    <input type="text" id="popout-opponent-deck" placeholder="${i18n.get('ph_deck_name')}" required>
                                </div>
                                <div class="form-group">
                                    <label>${i18n.get('label_turn_order')}</label>
                                    <select id="popout-turn-order">
                                        <option value="">${i18n.get('opt_not_selected')}</option>
                                        <option value="å…ˆæ‰‹">${i18n.get('opt_first')}</option>
                                        <option value="å¾Œæ‰‹">${i18n.get('opt_second')}</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>${i18n.get('label_result')}</label>
                                    <select id="popout-result">
                                        <option value="">${i18n.get('opt_not_selected')}</option>
                                        <option value="å‹åˆ©">${i18n.get('opt_win')}</option>
                                        <option value="æ•—åŒ—">${i18n.get('opt_lose')}</option>
                                        <option value="å¹³æ‰‹">${i18n.get('opt_draw')}</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>${i18n.get('label_score')}</label>
                                    <input type="number" id="popout-score" placeholder="${i18n.get('ph_score')}">
                                </div>
                                <div class="form-group">
                                    <label>${i18n.get('label_misplay')}</label>
                                    <select id="popout-misplay">
                                        <option value="">${i18n.get('opt_not_selected')}</option>
                                        <option value="ç„¡">${i18n.get('opt_none')}</option>
                                        <option value="è¼•åº¦">${i18n.get('opt_light')}</option>
                                        <option value="ä¸­ç­‰">${i18n.get('opt_medium')}</option>
                                        <option value="åš´é‡">${i18n.get('opt_severe')}</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>${i18n.get('label_misplay_note')}</label>
                                    <input type="text" id="popout-misplay-note" placeholder="${i18n.get('ph_optional')}">
                                </div>
                                <div class="form-group">
                                    <label>${i18n.get('label_game_name')}</label>
                                    <input type="text" id="popout-game-name" placeholder="${i18n.get('ph_game_name')}">
                                </div>
                                <div class="form-group">
                                    <label>${i18n.get('label_notes')}</label>
                                    <input type="text" id="popout-notes" placeholder="${i18n.get('ph_optional')}">
                                </div>
                            </div>
                            <div class="form-actions">
                                <div></div>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-ghost" onclick="document.getElementById('popout-record-form').reset()">${i18n.get('btn_clear')}</button>
                                    <button type="submit" class="btn btn-primary">${i18n.get('btn_save')}</button>
                                </div>
                            </div>
                        </form>
                    </div>
                `;

                document.getElementById('popout-record-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveRecord();
                });

                // ç¶å®šæ¸£æ“å‚™è¨»é‚è¼¯
                const misplaySelect = document.getElementById('popout-misplay');
                if (misplaySelect) {
                    misplaySelect.addEventListener('change', updatePopoutMisplayState);
                }
                updatePopoutMisplayState(); // åˆå§‹ç‹€æ…‹æª¢æŸ¥

                // ç¶å®šè¡Œè·æŒ‰éˆ• (Safeguard)
                const rowHeightBtns = document.querySelectorAll('#row-height-options .btn');
                rowHeightBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        rowHeightBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                });

                // Set initial active state for row height
                const currentSettings = DataManager.getColumnSettings() || {};
                const currentHeight = currentSettings.rowHeight || 'slim';
                const activeBtn = document.querySelector(`#row-height-options .btn[data-height="${currentHeight}"]`);
                if (activeBtn) activeBtn.classList.add('active');
            }

            /**
             * æ›´æ–°å½ˆå‡ºè¦–çª—æ¸£æ“å‚™è¨»ç‹€æ…‹
             */
            function updatePopoutMisplayState() {
                const select = document.getElementById('popout-misplay');
                const noteInput = document.getElementById('popout-misplay-note');
                if (!select || !noteInput) return;

                const val = select.value;
                const isDisabled = !val || val === '' || val === 'ç„¡';

                noteInput.disabled = isDisabled;
                if (isDisabled) {
                    noteInput.value = '';
                    noteInput.placeholder = i18n.get('ph_optional') || 'é¸å¡«';
                    noteInput.parentElement.classList.add('disabled-input');
                } else {
                    noteInput.parentElement.classList.remove('disabled-input');
                }
            }

            /**
             * å„²å­˜ç´€éŒ„
             */
            function saveRecord() {
                const record = {
                    id: Date.now().toString(),
                    date: formatDateForStorage(document.getElementById('popout-battle-date').value),
                    myDeck: document.getElementById('popout-my-deck').value.trim(),
                    opponentDeck: document.getElementById('popout-opponent-deck').value.trim(),
                    turnOrder: document.getElementById('popout-turn-order').value,
                    result: document.getElementById('popout-result').value,
                    score: document.getElementById('popout-score').value,
                    misplay: document.getElementById('popout-misplay').value,
                    misplayNote: document.getElementById('popout-misplay-note').value.trim(),
                    gameName: document.getElementById('popout-game-name').value.trim(),
                    notes: document.getElementById('popout-notes').value.trim(),
                    customFields: {}
                };

                DataManager.addRecord(record);
                SyncManager.broadcast(SyncManager.EventTypes.RECORD_ADDED, { record });

                document.getElementById('popout-record-form').reset();
                document.getElementById('popout-battle-date').value = new Date().toISOString().split('T')[0];

                alert(i18n.get('toast_save_success'));
            }

            function formatDateForStorage(dateStr) {
                if (!dateStr) return '';
                return dateStr.replace(/-/g, '/');
            }

            /**
             * æ¸²æŸ“ï¼šå°æˆ°ç´€éŒ„è¡¨æ ¼
             */
            function renderTableCard(providedRecords = null) {
                // åˆå§‹åŒ– TableManager
                TableManager.init();

                document.getElementById('popout-content').innerHTML = `
                    <div class="card">
                        <div class="card-header" style="padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                            <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                                <button id="column-settings-btn" class="btn btn-sm btn-outline" data-i18n="btn_column_settings">æ¬„ä½è¨­å®š</button>
                                <button id="toggle-misplay-notes-btn" class="btn btn-sm btn-outline" data-i18n="btn_show_misplay_notes">é¡¯ç¤ºæ¸£æ“å‚™è¨»</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table id="battle-records-table">
                                <thead>
                                    <tr id="table-header-row">
                                        <!-- èˆ‡ TableManager.renderTable() é€£å‹• -->
                                    </tr>
                                </thead>
                                <tbody id="records-tbody">
                                    <!-- èˆ‡ TableManager.renderTable() é€£å‹• -->
                                </tbody>
                            </table>
                        </div>

                        <div id="pagination-controls" class="pagination-controls">
                            <button id="page-first" class="btn btn-sm">â®ï¸</button>
                            <button id="page-prev-5" class="btn btn-sm">âª</button>
                            <button id="page-prev" class="btn btn-sm">â—€ï¸</button>
                            <span id="page-info">1 / 1</span>
                            <button id="page-next" class="btn btn-sm">â–¶ï¸</button>
                            <button id="page-next-5" class="btn btn-sm">â©</button>
                            <button id="page-last" class="btn btn-sm">â­ï¸</button>
                        </div>
                    </div>
                `;

                // å§”è¨— TableManager æ¸²æŸ“èˆ‡ç¶å®š
                TableManager.renderTable();

                // ç¶å®šå½ˆå‡ºè¦–çª—ç‰¹æœ‰çš„æŒ‰éˆ•äº‹ä»¶ (å°æ‡‰ TableManager çš„å‡½æ•¸)
                const btnColumn = document.getElementById('column-settings-btn');
                if (btnColumn) btnColumn.addEventListener('click', () => TableManager.openColumnSettingsModal());

                const btnMisplay = document.getElementById('toggle-misplay-notes-btn');
                if (btnMisplay) btnMisplay.addEventListener('click', () => TableManager.toggleMisplayNotes());

                // Bindings removed
            }

            /**
             * æ¸²æŸ“ï¼šæœå°‹æ¢ä»¶
             */
            function renderSearchCard() {
                document.getElementById('popout-content').innerHTML = `
                    <div class="card" style="padding: 2rem; text-align: center;">
                        <p style="color: var(--text-secondary);">æœå°‹æ¢ä»¶è«‹åœ¨ä¸»é é¢æ“ä½œ</p>
                    </div>
                `;
            }

            /**
             * æ¸²æŸ“ï¼šåˆ†æ•¸è¶¨å‹¢åœ–
             */
            function renderScoreChart(providedRecords = null) {
                document.getElementById('popout-content').innerHTML = `
                    <div class="card chart-card">
                        <div class="chart-container">
                            <canvas id="popout-score-chart"></canvas>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    let records = providedRecords;
                    if (!records) {
                        // å„ªå…ˆä½¿ç”¨éæ¿¾å¾Œçš„æœå°‹çµæœ
                        try {
                            const stored = localStorage.getItem('cardBattleSearchResults');
                            if (stored) {
                                records = JSON.parse(stored);
                            }
                        } catch (e) {
                            console.error('Failed to load search results:', e);
                        }
                        // è‹¥æœå°‹çµæœç‚ºç©ºï¼Œå‰‡ä½¿ç”¨å…¨éƒ¨ç´€éŒ„
                        if (!records || records.length === 0) {
                            records = DataManager.getRecords();
                        }
                    }
                    const ctx = document.getElementById('popout-score-chart');
                    if (ctx && records.length > 0) {
                        const scoresData = records

                            .filter(r => r.score)
                            .map((r, i) => ({ x: i + 1, y: parseInt(r.score), label: r.date }));

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: scoresData.map(d => d.label),
                                datasets: [{
                                    label: i18n.get('chart_score'),
                                    data: scoresData.map(d => d.y),
                                    borderColor: 'hsl(250, 80%, 60%)',
                                    backgroundColor: 'hsla(250, 80%, 60%, 0.1)',
                                    fill: true,
                                    tension: 0.3
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: { beginAtZero: false }
                                }
                            }
                        });
                    }
                }, 100);
            }

            /**
             * æ¸²æŸ“:ç‰Œçµ„åˆ†å¸ƒåœ–
             */
            function renderDeckChart(providedRecords = null) {
                // é¡è‰²èª¿è‰²ç›¤
                const colorPalette = [
                    'hsl(280, 70%, 60%)',   // ç´«è‰²
                    'hsl(145, 70%, 50%)',   // ç¶ è‰²
                    'hsl(45, 100%, 55%)',   // é»ƒè‰²
                    'hsl(0, 70%, 55%)',     // ç´…è‰²
                    'hsl(200, 80%, 55%)',   // è—è‰²
                    'hsl(320, 70%, 60%)',   // ç²‰ç´…
                    'hsl(30, 90%, 55%)',    // æ©™è‰²
                    'hsl(170, 70%, 50%)',   // é’ç¶ 
                    'hsl(260, 60%, 65%)',   // æ·¡ç´«
                    'hsl(60, 80%, 50%)'     // é»ƒç¶ 
                ];

                document.getElementById('popout-content').innerHTML = `
                    <div class="card chart-card" style="height: auto;">
                        <div style="padding: 1.2rem;">
                            <div style="height: 500px;">
                                <canvas id="popout-deck-chart"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    let records = providedRecords;
                    if (!records) {
                        try {
                            const stored = localStorage.getItem('cardBattleSearchResults');
                            if (stored) {
                                records = JSON.parse(stored);
                            }
                        } catch (e) {
                            console.error('Failed to load search results:', e);
                        }
                        if (!records || records.length === 0) {
                            records = DataManager.getRecords();
                        }
                    }

                    const ctx = document.getElementById('popout-deck-chart');

                    if (!records || records.length === 0) {
                        ctx.parentElement.innerHTML = '<div style="color: var(--text-muted); padding: 1rem; text-align: center;">æ²’æœ‰è³‡æ–™å¯é¡¯ç¤º</div>';
                        return;
                    }

                    // çµ±è¨ˆå°æ‰‹ç‰Œçµ„åˆ†å¸ƒ
                    const deckCounts = {};
                    records.forEach(r => {
                        if (r.opponentDeck) {
                            deckCounts[r.opponentDeck] = (deckCounts[r.opponentDeck] || 0) + 1;
                        }
                    });

                    // æ’åº
                    const sortedDecks = Object.entries(deckCounts).sort((a, b) => b[1] - a[1]);

                    if (sortedDecks.length === 0) {
                        ctx.parentElement.innerHTML = '<div style="color: var(--text-muted); padding: 1rem; text-align: center;">æ²’æœ‰å°æ‰‹ç‰Œçµ„è³‡æ–™</div>';
                        return;
                    }

                    const totalGames = records.length;

                    // å¦‚æœè¶…é10ç¨®ç‰Œçµ„,å°‡å¾Œé¢çš„åˆä½µç‚ºã€Œå…¶ä»–ã€
                    let displayDecks = [];
                    let othersData = [];

                    if (sortedDecks.length > 10) {
                        const top9 = sortedDecks.slice(0, 9);
                        const others = sortedDecks.slice(9);
                        const othersSum = others.reduce((sum, [_, count]) => sum + count, 0);
                        othersData = others;

                        displayDecks = [...top9, [i18n.get('opt_others') || 'å…¶ä»–', othersSum]];
                    } else {
                        displayDecks = sortedDecks;
                    }

                    const labels = displayDecks.map(([deck]) => deck);
                    const data = displayDecks.map(([_, count]) => count);
                    const colors = displayDecks.map((_, i) => colorPalette[i % colorPalette.length]);

                    // å‰µå»ºåœ–è¡¨ (å•Ÿç”¨é è¨­åœ–ä¾‹)
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels,
                            datasets: [{
                                data,
                                backgroundColor: colors,
                                borderColor: '#ffffff',
                                borderWidth: 2,
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: 'hsla(0, 0%, 100%, 0.9)',
                                        padding: 15,
                                        usePointStyle: true,
                                        pointStyle: 'rect',
                                        boxWidth: 18,
                                        boxHeight: 14,
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'hsla(230, 25%, 15%, 0.95)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'hsla(250, 80%, 60%, 0.5)',
                                    borderWidth: 1,
                                    padding: 12,
                                    callbacks: {
                                        label: function (context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.raw / total) * 100).toFixed(1);
                                            return `${context.label}: ${context.raw} å ´ (${percentage}%)`;
                                        },
                                        afterBody: function (context) {
                                            // å¦‚æœæ˜¯ã€Œå…¶ä»–ã€é¡åˆ¥,é¡¯ç¤ºè©³ç´°è³‡è¨Š
                                            const othersLabel = i18n.get('opt_others') || 'å…¶ä»–';
                                            if (context[0] && context[0].label === othersLabel && othersData.length > 0) {
                                                const lines = ['', 'åŒ…å«:'];
                                                othersData.forEach(([deck, count]) => {
                                                    const pct = ((count / totalGames) * 100).toFixed(1);
                                                    lines.push(`  ${deck}: ${count}å ´ (${pct}%)`);
                                                });
                                                return lines;
                                            }
                                            return [];
                                        }
                                    }
                                }
                            },
                            cutout: '50%'
                        }
                    });
                }, 200);
            }



            /**
             * æ¸²æŸ“ï¼šçµ±è¨ˆæ‘˜è¦
             */
            function renderStatsGrid(providedRecords = null) {
                let records = providedRecords;
                if (!records) {
                    // å„ªå…ˆä½¿ç”¨éæ¿¾å¾Œçš„æœå°‹çµæœ
                    try {
                        const stored = localStorage.getItem('cardBattleSearchResults');
                        if (stored) {
                            records = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.error('Failed to load search results:', e);
                    }
                    // è‹¥æœå°‹çµæœç‚ºç©ºï¼Œå‰‡ä½¿ç”¨å…¨éƒ¨ç´€éŒ„
                    if (!records || records.length === 0) {
                        records = DataManager.getRecords();
                    }
                }

                // å¾ DataManager è¼‰å…¥è¨ˆç®—è¨­å®š
                const calcSettings = DataManager.getCalcSettings();
                const excludeDraws = calcSettings.excludeDraws;
                const calcNoDrawId = 'popout-calc-no-draw';

                const total = records.length;

                // è¨ˆç®—ç´°é …
                const wins = records.filter(r => r.result === 'å‹åˆ©').length;
                const draws = records.filter(r => r.result === 'å¹³æ‰‹').length;
                const unrecorded = records.filter(r => !r.result || (r.result !== 'å‹åˆ©' && r.result !== 'æ•—åŒ—' && r.result !== 'å¹³æ‰‹')).length;

                const firstMoves = records.filter(r => r.turnOrder === 'å…ˆæ‰‹').length;
                const firstWins = records.filter(r => r.turnOrder === 'å…ˆæ‰‹' && r.result === 'å‹åˆ©').length;
                const firstDraws = records.filter(r => r.turnOrder === 'å…ˆæ‰‹' && r.result === 'å¹³æ‰‹').length;
                const firstUnrecorded = records.filter(r => r.turnOrder === 'å…ˆæ‰‹' && (!r.result || (r.result !== 'å‹åˆ©' && r.result !== 'æ•—åŒ—' && r.result !== 'å¹³æ‰‹'))).length;

                const secondMoves = records.filter(r => r.turnOrder === 'å¾Œæ‰‹').length;
                const secondWins = records.filter(r => r.turnOrder === 'å¾Œæ‰‹' && r.result === 'å‹åˆ©').length;
                const secondDraws = records.filter(r => r.turnOrder === 'å¾Œæ‰‹' && r.result === 'å¹³æ‰‹').length;
                const secondUnrecorded = records.filter(r => r.turnOrder === 'å¾Œæ‰‹' && (!r.result || (r.result !== 'å‹åˆ©' && r.result !== 'æ•—åŒ—' && r.result !== 'å¹³æ‰‹'))).length;

                // åŒæ­¥ä¸»é é¢çš„è¨ˆç®—é‚è¼¯
                const totalValid = total - unrecorded;
                const totalDenominator = excludeDraws ? (totalValid - draws) : totalValid;
                const firstDenominator = excludeDraws ? (firstMoves - firstDraws - firstUnrecorded) : (firstMoves - firstUnrecorded);
                const secondDenominator = excludeDraws ? (secondMoves - secondDraws - secondUnrecorded) : (secondMoves - secondUnrecorded);

                const turnDenominator = firstMoves + secondMoves;
                const winRate = totalDenominator > 0 ? ((wins / totalDenominator) * 100).toFixed(1) : '0.0';
                const firstRate = turnDenominator > 0 ? ((firstMoves / turnDenominator) * 100).toFixed(1) : '0.0';
                const firstWinRate = firstDenominator > 0 ? ((firstWins / firstDenominator) * 100).toFixed(1) : '0.0';
                const secondWinRate = secondDenominator > 0 ? ((secondWins / secondDenominator) * 100).toFixed(1) : '0.0';

                // è¨ˆç®—é™„è¨»è³‡è¨Š
                const turnUnrecordedCount = records.filter(r => !r.turnOrder).length;
                const statNotes = [];
                if (draws > 0) statNotes.push(`${i18n.get('label_draw_stat')}<i>${draws}</i>`);
                if (unrecorded > 0) statNotes.push(`${i18n.get('label_unrecorded')}<i>${unrecorded}</i>`);
                if (turnUnrecordedCount > 0) statNotes.push(`${i18n.get('label_turn_unrecorded')}<i>${turnUnrecordedCount}</i>`);

                let noteText = statNotes.length > 0 ? statNotes.join('') : '';
                if (noteText) noteText += '<br>' + i18n.get('label_calc_note_suffix');

                const statNoteHtml = noteText ? `<div class="stat-note">${noteText}</div>` : '';

                // ä¿å­˜ç•¶å‰ç°¡æ˜“æ¨¡å¼ç‹€æ…‹
                const wasSimpleMode = localStorage.getItem('statsDisplayMode') === 'simple';

                const contentEl = document.getElementById('popout-content');
                contentEl.innerHTML = `
                    <div style="margin-bottom: 1rem; display: flex; justify-content: flex-end;">
                        <label class="checkbox-inline" style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                            <input type="checkbox" id="${calcNoDrawId}" ${excludeDraws ? 'checked' : ''}>
                            <span data-i18n="label_calc_no_draw">${i18n.get('label_calc_no_draw')}</span>
                        </label>
                    </div>
                    <div class="stats-grid">
                        <div class="card stat-card">
                            <div class="stat-icon">ğŸ“Š</div>
                            <div class="stat-content">
                                <div class="stat-label">${i18n.get('stat_total')}</div>
                                <div class="stat-value-container" style="text-align: right;">
                                    <div class="stat-value">${total}</div>
                                    ${statNoteHtml}
                                </div>
                            </div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-icon">ğŸ†</div>
                            <div class="stat-content">
                                <div class="stat-label">${i18n.get('stat_win_rate')}</div>
                                <div class="stat-value">${winRate}%</div>
                            </div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-icon">ğŸ¯</div>
                            <div class="stat-content">
                                <div class="stat-label">${i18n.get('stat_first_rate')}</div>
                                <div class="stat-value">${firstRate}%</div>
                            </div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-icon">â­</div>
                            <div class="stat-content">
                                <div class="stat-label">${i18n.get('stat_first_win_rate')}</div>
                                <div class="stat-value">${firstWinRate}%</div>
                            </div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-icon">ğŸŒ™</div>
                            <div class="stat-content">
                                <div class="stat-label">${i18n.get('stat_second_win_rate')}</div>
                                <div class="stat-value">${secondWinRate}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // é‡æ–°ç¶å®šäº‹ä»¶
                document.getElementById(calcNoDrawId).addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    // å„²å­˜è¨­å®šä¸¦å»£æ’­
                    DataManager.saveCalcSettings({ excludeDraws: isChecked });
                    SyncManager.broadcast(SyncManager.EventTypes.SETTINGS_CHANGED, {
                        calcSettings: { excludeDraws: isChecked }
                    });
                    renderStatsGrid(providedRecords);
                });

                // æ¢å¾©ç°¡æ˜“æ¨¡å¼ç‹€æ…‹
                if (wasSimpleMode) {
                    setTimeout(() => {
                        setSimpleStatsMode(true);
                    }, 0);
                }
            }

            /**
             * æ¸²æŸ“ï¼šæœå°‹çµæœ
             */
            function renderSearchResults(providedRecords = null) {
                let searchResults = [];

                // å„ªå…ˆä½¿ç”¨å‚³å…¥çš„åŸå§‹ç´€éŒ„é€²è¡Œéæ¿¾ï¼Œå¦å‰‡å¾ localStorage è®€å–å·²éæ¿¾çµæœ
                if (providedRecords && Array.isArray(providedRecords)) {
                    // å¾ localStorage è®€å–ç›®å‰çš„ç¯©é¸æ¢ä»¶
                    let filters = { customFields: {} };
                    try {
                        const storedFilters = localStorage.getItem('cardBattleSearchFilters');
                        if (storedFilters) {
                            filters = JSON.parse(storedFilters);
                        }
                    } catch (e) {
                        console.error('Failed to load filters:', e);
                    }

                    // åŸ·è¡Œèˆ‡ SearchManager ç›¸åŒçš„éæ¿¾é‚è¼¯
                    searchResults = providedRecords.filter(record => {
                        // æ—¥æœŸç¯„åœ (æ³¨æ„æ ¼å¼è½‰æ›)
                        if (filters.dateStart && record.date) {
                            const recordDate = new Date(record.date.replace(/\//g, '-'));
                            const startDate = new Date(filters.dateStart);
                            if (recordDate < startDate) return false;
                        }
                        if (filters.dateEnd && record.date) {
                            const recordDate = new Date(record.date.replace(/\//g, '-'));
                            const endDate = new Date(filters.dateEnd);
                            if (recordDate > endDate) return false;
                        }

                        if (filters.myDeck && record.myDeck !== filters.myDeck) return false;
                        if (filters.opponentDeck && record.opponentDeck !== filters.opponentDeck) return false;
                        if (filters.turnOrder && record.turnOrder !== filters.turnOrder) return false;

                        // å‹è² è™•ç†
                        if (filters.result === 'å¹³æ‰‹' && record.result === 'å¹³æ‰‹') {
                            // ä¿æŒé€šé
                        } else if (filters.result && record.result !== filters.result) {
                            return false;
                        }

                        if (filters.gameName && record.gameName !== filters.gameName) return false;
                        if (filters.scoreStart !== '' && record.score !== undefined && record.score < parseInt(filters.scoreStart)) return false;
                        if (filters.scoreEnd !== '' && record.score !== undefined && record.score > parseInt(filters.scoreEnd)) return false;

                        if (filters.keyword) {
                            const keyword = filters.keyword.toLowerCase();
                            const notes = (record.notes || '').toLowerCase();
                            const misplayNote = (record.misplayNote || '').toLowerCase();
                            if (!notes.includes(keyword) && !misplayNote.includes(keyword)) return false;
                        }

                        // è‡ªè¨‚æ¬„ä½
                        for (const [fieldId, value] of Object.entries(filters.customFields || {})) {
                            if (value && record[fieldId] !== value) return false;
                        }
                        return true;
                    });

                    // å„²å­˜éæ¿¾å¾Œçš„çµæœä¾›å¾ŒçºŒä½¿ç”¨
                    localStorage.setItem('cardBattleSearchResults', JSON.stringify(searchResults));
                } else {
                    try {
                        const stored = localStorage.getItem('cardBattleSearchResults');
                        if (stored) {
                            searchResults = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.error('Failed to load search results:', e);
                    }
                }

                document.getElementById('popout-content').innerHTML = `
                    <div class="card" id="search-results-card">
                        <div class="card-header" style="padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                            <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                                <span id="search-result-count" class="badge"></span>
                            </div>
                            <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                                <button id="search-toggle-misplay-notes-btn" class="btn btn-sm btn-outline" data-i18n="btn_show_misplay_notes">é¡¯ç¤ºæ¸£æ“å‚™è¨»</button>
                                <button id="search-column-settings-btn" class="btn btn-sm btn-outline" data-i18n="btn_column_settings">æ¬„ä½è¨­å®š</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table id="search-results-table">
                                <thead>
                                    <tr id="search-table-header-row"></tr>
                                </thead>
                                <tbody id="search-results-tbody"></tbody>
                            </table>
                        </div>

                        <div id="no-search-results" class="no-records hidden">
                            <span class="no-records-icon">ğŸ”</span>
                            <p data-i18n="search_prompt">è«‹è¨­å®šæœå°‹æ¢ä»¶å¾Œé»æ“Šæœå°‹æŒ‰éˆ•</p>
                        </div>

                        <div id="search-pagination-controls" class="pagination-controls hidden">
                            <button id="search-page-first" class="btn btn-sm">â®ï¸</button>
                            <button id="search-page-prev-5" class="btn btn-sm">âª</button>
                            <button id="search-page-prev" class="btn btn-sm">â—€ï¸</button>
                            <span id="search-page-info">1 / 1</span>
                            <button id="search-page-next" class="btn btn-sm">â–¶ï¸</button>
                            <button id="search-page-next-5" class="btn btn-sm">â©</button>
                            <button id="search-page-last" class="btn btn-sm">â­ï¸</button>
                            <div class="page-jump">
                                <input type="number" id="search-page-jump-input" min="1" step="1">
                                <button id="search-page-jump-btn" class="btn btn-sm btn-primary">âœ”</button>
                            </div>
                        </div>
                    </div>
                `;

                // ç›´æ¥æ¸²æŸ“æœå°‹çµæœï¼Œä¸ä½¿ç”¨ SearchManagerï¼ˆé¿å…é‡è¤‡åˆå§‹åŒ–å’Œç„¡é™è¿´åœˆï¼‰
                renderSearchResultsTable(searchResults);

                // ç¶å®šæŒ‰éˆ•äº‹ä»¶ï¼ˆå½ˆå‡ºè¦–çª—å°ˆç”¨å¯¦ä½œï¼‰
                const btnMisplay = document.getElementById('search-toggle-misplay-notes-btn');
                if (btnMisplay) {
                    btnMisplay.addEventListener('click', () => {
                        togglePopoutMisplayNotes();
                    });
                }

                const btnColumn = document.getElementById('search-column-settings-btn');
                if (btnColumn) {
                    btnColumn.addEventListener('click', () => {
                        openPopoutColumnSettings();
                    });
                }
            }

            /**
             * å½ˆå‡ºè¦–çª—å°ˆç”¨ï¼šåˆ‡æ›æ¸£æ“å‚™è¨»é¡¯ç¤º
             */
            let isPopoutMisplayNotesVisible = false;
            function togglePopoutMisplayNotes() {
                isPopoutMisplayNotesVisible = !isPopoutMisplayNotesVisible;
                const btn = document.getElementById('search-toggle-misplay-notes-btn');
                const table = document.getElementById('search-results-table');

                if (isPopoutMisplayNotesVisible) {
                    table?.classList.add('show-misplay-notes');
                    if (btn) btn.textContent = i18n.get('btn_hide_misplay_notes') || 'éš±è—æ¸£æ“å‚™è¨»';
                } else {
                    table?.classList.remove('show-misplay-notes');
                    if (btn) btn.textContent = i18n.get('btn_show_misplay_notes') || 'é¡¯ç¤ºæ¸£æ“å‚™è¨»';
                }

                // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥é¡¯ç¤º/éš±è—å‚™è¨»ï¼ˆä½¿ç”¨ localStorage ä¸­çš„éæ¿¾çµæœï¼‰
                let searchResults = [];
                try {
                    const stored = localStorage.getItem('cardBattleSearchResults');
                    if (stored) {
                        searchResults = JSON.parse(stored);
                    }
                } catch (e) {
                    console.error('Failed to load search results:', e);
                }
                renderSearchResultsTable(searchResults);
                // æ³¨æ„ï¼šä¸å»£æ’­æ­¤è®Šæ›´ï¼Œå› ç‚ºæ¸£æ“å‚™è¨»é¡¯ç¤ºæ˜¯å½ˆå‡ºè¦–çª—çš„æœ¬åœ°è¨­å®š
            }


            /**
             * å½ˆå‡ºè¦–çª—å°ˆç”¨ï¼šé–‹å•Ÿæ¬„ä½è¨­å®š
             */
            function openPopoutColumnSettings() {
                const modal = document.getElementById('column-settings-modal');
                if (!modal) return;

                // é¡¯ç¤º Modal
                modal.classList.add('active');

                // è¼‰å…¥æœå°‹å°ˆç”¨æ¬„ä½è¨­å®š
                const columnSettings = DataManager.getSearchColumnSettings ?
                    DataManager.getSearchColumnSettings() :
                    (DataManager.getColumnSettings() || { visible: {}, widths: {} });

                // æ¸²æŸ“æ¬„ä½å‹¾é¸æ¡†ï¼ˆç§»é™¤åœ–ç¤ºï¼‰
                const container = document.getElementById('column-checkbox-list');
                if (container) {
                    const allColumns = [
                        { id: 'date', label: i18n.get('th_date') || 'æ—¥æœŸ' },
                        { id: 'myDeck', label: i18n.get('th_my_deck') || 'å·±æ–¹ç‰Œçµ„' },
                        { id: 'opponentDeck', label: i18n.get('th_opponent_deck') || 'å°æ‰‹ç‰Œçµ„' },
                        { id: 'turnOrder', label: i18n.get('th_turn') || 'å…ˆå¾Œæ‰‹' },
                        { id: 'result', label: i18n.get('th_result') || 'å‹è² ' },
                        { id: 'score', label: i18n.get('th_score') || 'åˆ†æ•¸' },
                        { id: 'misplay', label: i18n.get('th_misplay') || 'æ¸£æ“' },
                        { id: 'gameName', label: i18n.get('th_game_name') || 'éŠæˆ²' },
                        { id: 'notes', label: i18n.get('th_notes') || 'å‚™è¨»' },
                        { id: 'createdAt', label: i18n.get('th_created_at') || 'å»ºç«‹æ™‚é–“' }
                    ];

                    container.innerHTML = allColumns.map(col => {
                        // gameName å’Œ createdAt é è¨­ç‚ºéš±è—ï¼ˆéœ€ visible[id] === trueï¼‰
                        let isChecked;
                        if (col.id === 'gameName' || col.id === 'createdAt') {
                            isChecked = columnSettings.visible[col.id] === true;
                        } else {
                            isChecked = columnSettings.visible[col.id] !== false;
                        }

                        return `
                        <label class="column-toggle-item">
                            <input type="checkbox" 
                                   id="col-checkbox-${col.id}" 
                                   value="${col.id}" 
                                   ${isChecked ? 'checked' : ''}>
                            <span>${col.label}</span>
                        </label>
                    `;
                    }).join('');
                }

                // ç¶å®šå„²å­˜æŒ‰éˆ•
                const confirmBtn = document.getElementById('confirm-columns-btn');
                if (confirmBtn) {
                    confirmBtn.onclick = () => {
                        savePopoutColumnSettings();
                    };
                }

                // ç¶å®šæ¢å¾©é è¨­æŒ‰éˆ•
                const resetBtn = document.getElementById('btn-reset-default');
                if (resetBtn) {
                    resetBtn.onclick = () => {
                        resetPopoutColumnSettings();
                    };
                }
            }

            /**
             * æ¢å¾©é è¨­æ¬„ä½è¨­å®šï¼ˆå½ˆå‡ºè¦–çª—ï¼‰
             */
            function resetPopoutColumnSettings() {
                const newSettings = {
                    visible: {},
                    widths: {},
                    rowHeight: 'slim'
                };

                // gameName å’Œ createdAt é è¨­ç‚ºéš±è—
                const baseFields = ['date', 'myDeck', 'opponentDeck', 'turnOrder', 'result', 'score', 'gameName', 'misplay', 'notes', 'createdAt'];
                baseFields.forEach(f => {
                    if (f === 'gameName' || f === 'createdAt') {
                        newSettings.visible[f] = false;
                    } else {
                        newSettings.visible[f] = true;
                    }
                });

                // å„²å­˜æœå°‹å°ˆç”¨è¨­å®š
                if (DataManager.saveSearchColumnSettings) {
                    DataManager.saveSearchColumnSettings(newSettings);
                } else {
                    DataManager.saveColumnSettings(newSettings);
                }

                // å»£æ’­è®Šæ›´
                if (typeof SyncManager !== 'undefined') {
                    SyncManager.broadcast(SyncManager.EventTypes.SETTINGS_CHANGED, {
                        searchColumnSettings: newSettings
                    });
                }

                // é‡æ–°é–‹å•Ÿ Modal ä»¥æ›´æ–°é¡¯ç¤º
                openPopoutColumnSettings();

                // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                let searchResults = [];
                try {
                    const stored = localStorage.getItem('cardBattleSearchResults');
                    if (stored) {
                        searchResults = JSON.parse(stored);
                    }
                } catch (e) {
                    console.error('Failed to load search results:', e);
                }
                renderSearchResultsTable(searchResults);
            }


            /**
             * å„²å­˜æ¬„ä½è¨­å®šä¸¦é‡æ–°æ¸²æŸ“
             */
            function savePopoutColumnSettings() {
                const checkboxes = document.querySelectorAll('#column-checkbox-list input[type="checkbox"]');

                // å–å¾—æœå°‹å°ˆç”¨æ¬„ä½è¨­å®š
                const currentSettings = DataManager.getSearchColumnSettings ?
                    DataManager.getSearchColumnSettings() :
                    (DataManager.getColumnSettings() || { visible: {}, widths: {} });

                if (!currentSettings.visible) currentSettings.visible = {};

                // æ›´æ–° visible è¨­å®š
                checkboxes.forEach(cb => {
                    currentSettings.visible[cb.value] = cb.checked;
                });

                // å„²å­˜æœå°‹å°ˆç”¨è¨­å®š
                if (DataManager.saveSearchColumnSettings) {
                    DataManager.saveSearchColumnSettings(currentSettings);
                } else {
                    DataManager.saveColumnSettings(currentSettings);
                }

                // å»£æ’­æ¬„ä½è¨­å®šè®Šæ›´ï¼ˆé›™å‘åŒæ­¥ï¼‰
                if (typeof SyncManager !== 'undefined') {
                    SyncManager.broadcast(SyncManager.EventTypes.SETTINGS_CHANGED, {
                        searchColumnSettings: currentSettings
                    });
                }

                // é—œé–‰ Modal
                const modal = document.getElementById('column-settings-modal');
                if (modal) modal.classList.remove('active');

                // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                let searchResults = [];
                try {
                    const stored = localStorage.getItem('cardBattleSearchResults');
                    if (stored) {
                        searchResults = JSON.parse(stored);
                    }
                } catch (e) {
                    console.error('Failed to load search results:', e);
                }
                renderSearchResultsTable(searchResults);
            }


            /**
             * æ¸²æŸ“æœå°‹çµæœè¡¨æ ¼ï¼ˆå½ˆå‡ºè¦–çª—å°ˆç”¨ï¼Œä¸è§¸ç™¼ SearchManagerï¼‰
             */
            let popoutSortField = 'date';
            let popoutSortDirection = 'desc';
            let currentResizerField = null;
            let startX = 0;
            let startWidth = 0;

            function renderSearchResultsTable(results) {
                const tbody = document.getElementById('search-results-tbody');
                const headerRow = document.getElementById('search-table-header-row');
                const countBadge = document.getElementById('search-result-count');
                const noResults = document.getElementById('no-search-results');

                if (!tbody || !headerRow) return;

                // æ›´æ–°çµæœæ•¸é‡ï¼ˆä½¿ç”¨æ­£ç¢ºçš„ç¿»è­¯éµï¼‰
                if (countBadge) {
                    countBadge.textContent = i18n.get('result_count', results.length);
                }

                // å¦‚æœæ²’æœ‰çµæœï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
                if (results.length === 0) {
                    tbody.innerHTML = '';
                    if (noResults) noResults.classList.remove('hidden');
                    return;
                }

                if (noResults) noResults.classList.add('hidden');

                // è¼‰å…¥æœå°‹å°ˆç”¨æ¬„ä½è¨­å®š
                const columnSettings = DataManager.getSearchColumnSettings ?
                    DataManager.getSearchColumnSettings() :
                    (DataManager.getColumnSettings() || {});
                if (!columnSettings.visible) columnSettings.visible = {};
                const columnWidths = columnSettings.widths || {};


                // å®šç¾©æ‰€æœ‰å¯ç”¨çš„æ¬„ä½ï¼ˆåŠ å…¥ createdAtï¼‰
                const allColumns = [
                    { id: 'date', label: i18n.get('th_date') || 'æ—¥æœŸ' },
                    { id: 'myDeck', label: i18n.get('th_my_deck') || 'å·±æ–¹ç‰Œçµ„' },
                    { id: 'opponentDeck', label: i18n.get('th_opponent_deck') || 'å°æ‰‹ç‰Œçµ„' },
                    { id: 'turnOrder', label: i18n.get('th_turn') || 'å…ˆå¾Œæ‰‹' },
                    { id: 'result', label: i18n.get('th_result') || 'å‹è² ' },
                    { id: 'score', label: i18n.get('th_score') || 'åˆ†æ•¸' },
                    { id: 'misplay', label: i18n.get('th_misplay') || 'æ¸£æ“' },
                    { id: 'gameName', label: i18n.get('th_game_name') || 'éŠæˆ²' },
                    { id: 'notes', label: i18n.get('th_notes') || 'å‚™è¨»' },
                    { id: 'createdAt', label: i18n.get('th_created_at') || 'å»ºç«‹æ™‚é–“' }
                ];

                // éæ¿¾éš±è—çš„æ¬„ä½ï¼ˆgameName å’Œ createdAt éœ€æ˜ç¢ºè¨­ç‚º trueï¼‰
                const visibleColumns = allColumns.filter(col => {
                    if (col.id === 'gameName' || col.id === 'createdAt') {
                        return columnSettings.visible[col.id] === true;
                    } else {
                        return columnSettings.visible[col.id] !== false;
                    }
                });

                // æ¸²æŸ“è¡¨é ­ï¼ˆå«æ’åºå’Œèª¿æ•´å¯¬åº¦åŠŸèƒ½ï¼‰
                headerRow.innerHTML = visibleColumns.map(col => {
                    const width = columnWidths[col.id] ? ` style="width: ${columnWidths[col.id]}"` : '';
                    const activeClass = popoutSortField === col.id ? 'active' : '';
                    const indicator = popoutSortField === col.id ? (popoutSortDirection === 'asc' ? 'â–²' : 'â–¼') : 'â†•';

                    return `<th data-col="${col.id}"${width} class="sortable">
                        <span>${col.label}</span>
                        <span class="sort-indicator ${activeClass}">${indicator}</span>
                        <div class="resizer"></div>
                    </th>`;
                }).join('');

                // ç¶å®šæ’åºäº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”è¨—ï¼‰
                headerRow.querySelectorAll('th.sortable').forEach(th => {
                    th.addEventListener('click', (e) => {
                        // é¿å…é»æ“Š resizer æ™‚è§¸ç™¼æ’åº
                        if (e.target.classList.contains('resizer')) return;
                        const field = th.dataset.col;
                        handlePopoutHeaderClick(field);
                    });
                });

                // ç¶å®šèª¿æ•´å¯¬åº¦äº‹ä»¶
                headerRow.querySelectorAll('.resizer').forEach(resizer => {
                    resizer.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        const th = resizer.parentElement;
                        const field = th.dataset.col;
                        initPopoutResize(e, field);
                    });
                });

                // æ’åºçµæœ
                const sortedResults = [...results].sort((a, b) => {
                    let aVal = a[popoutSortField];
                    let bVal = b[popoutSortField];

                    // è™•ç†æ—¥æœŸ
                    if (popoutSortField === 'date') {
                        aVal = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date(0);
                        bVal = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date(0);
                    }

                    // è™•ç†æ•¸å­—
                    if (popoutSortField === 'score') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    }

                    // è½‰å­—ä¸²æ¯”è¼ƒ
                    if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                    if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                    if (aVal < bVal) return popoutSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return popoutSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });

                // æ¸²æŸ“è¡¨æ ¼å…§å®¹
                tbody.innerHTML = sortedResults.map(record => {
                    // æ¨£å¼é¡åˆ¥
                    let resultClass = 'none';
                    if (record.result === 'å‹åˆ©') resultClass = 'win';
                    else if (record.result === 'æ•—åŒ—') resultClass = 'lose';
                    else if (record.result === 'å¹³æ‰‹') resultClass = 'draw';

                    let turnClass = 'none';
                    if (record.turnOrder === 'å…ˆæ‰‹') turnClass = 'first';
                    else if (record.turnOrder === 'å¾Œæ‰‹') turnClass = 'second';

                    const misplayClass = getMisplayClass(record.misplay);

                    const cells = visibleColumns.map(col => {
                        let content = '';
                        const width = columnWidths[col.id] ? ` style="width: ${columnWidths[col.id]}"` : '';

                        switch (col.id) {
                            case 'date':
                                content = escapeHtml(i18n.formatDate(record.date) || '');
                                break;
                            case 'myDeck':
                            case 'opponentDeck':
                            case 'gameName':
                            case 'notes':
                                content = escapeHtml(record[col.id] || '');
                                break;
                            case 'turnOrder':
                                content = `<span class="turn-badge ${turnClass}">${escapeHtml(i18n.get(record.turnOrder) || '')}</span>`;
                                break;
                            case 'result':
                                content = `<span class="result-badge ${resultClass}">${escapeHtml(i18n.get(record.result) || '')}</span>`;
                                break;
                            case 'score':
                                content = escapeHtml(String(record.score !== undefined ? record.score : ''));
                                break;
                            case 'misplay':
                                const misplayText = escapeHtml(i18n.get(record.misplay) || '');
                                if (isPopoutMisplayNotesVisible && record.misplayNote) {
                                    content = `<span class="misplay-badge ${misplayClass}">${misplayText}</span>
                                             <span class="misplay-note-text">${escapeHtml(record.misplayNote)}</span>`;
                                } else if (record.misplayNote) {
                                    content = `<span class="misplay-badge ${misplayClass}" data-tooltip="${escapeHtml(record.misplayNote)}" style="cursor: help;">${misplayText}</span>`;
                                } else {
                                    content = `<span class="misplay-badge ${misplayClass}">${misplayText}</span>`;
                                }
                                break;
                        }

                        return `<td${width}>${content}</td>`;
                    }).join('');

                    return `<tr>${cells}</tr>`;
                }).join('');
            }

            /**
             * Misplay ç­‰ç´šæ¨£å¼
             */
            function getMisplayClass(misplay) {
                switch (misplay) {
                    case 'åš´é‡': return 'severe';
                    case 'ä¸­ç­‰': return 'medium';
                    case 'è¼•åº¦': return 'light';
                    default: return 'none';
                }
            }

            /**
             * è™•ç†æ’åºï¼ˆå½ˆå‡ºè¦–çª—ï¼‰
             */
            function handlePopoutHeaderClick(field) {
                if (popoutSortField === field) {
                    popoutSortDirection = popoutSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    popoutSortField = field;
                    popoutSortDirection = 'desc';
                }

                // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                let searchResults = [];
                try {
                    const stored = localStorage.getItem('cardBattleSearchResults');
                    if (stored) {
                        searchResults = JSON.parse(stored);
                    }
                } catch (e) {
                    console.error('Failed to load search results:', e);
                }
                renderSearchResultsTable(searchResults);

                // å»£æ’­æ’åºç‹€æ…‹è®Šæ›´
                if (typeof SyncManager !== 'undefined') {
                    SyncManager.broadcast(SyncManager.EventTypes.SETTINGS_CHANGED, {
                        popoutSort: { field: popoutSortField, direction: popoutSortDirection }
                    });
                }
            }

            /**
             * åˆå§‹åŒ–èª¿æ•´å¯¬åº¦ï¼ˆå½ˆå‡ºè¦–çª—ï¼‰
             */
            function initPopoutResize(e, field) {
                currentResizerField = field;
                const th = e.target.parentElement;
                startX = e.pageX;
                startWidth = th.offsetWidth;

                document.body.classList.add('resizing');
                document.addEventListener('mousemove', handlePopoutResizeMove);
                document.addEventListener('mouseup', stopPopoutResize);
            }

            /**
             * è¨­å®šçµ±è¨ˆæ‘˜è¦ç°¡æ˜“é¡¯ç¤ºæ¨¡å¼
             * @param {boolean} active - æ˜¯å¦é–‹å•Ÿç°¡æ˜“æ¨¡å¼
             */
            function setSimpleStatsMode(active) {
                const statsGrid = document.querySelector('#popout-content .stats-grid');
                const btn = document.getElementById('toggle-simple-stats-btn');

                if (!statsGrid || !btn) return;

                if (active) {
                    statsGrid.classList.add('stats-simple-mode');
                    btn.innerHTML = 'ğŸ“Š <span data-i18n="btn_standard_display">æ¨™æº–é¡¯ç¤º</span>';
                    localStorage.setItem('statsDisplayMode', 'simple');
                } else {
                    statsGrid.classList.remove('stats-simple-mode');
                    btn.innerHTML = 'ğŸ“‹ <span data-i18n="btn_simple_display">ç°¡æ˜“é¡¯ç¤º</span>';
                    localStorage.setItem('statsDisplayMode', 'standard');
                }

                // é‡æ–°æ‡‰ç”¨ç¿»è­¯
                if (typeof i18n !== 'undefined') {
                    i18n.updatePageLanguage();
                }

                // æ›´æ–°ç¶²å€åƒæ•¸ï¼Œä»¥ä¾¿è¤‡è£½ç¶²å€æ™‚èƒ½ä¿æŒç‹€æ…‹
                try {
                    const url = new URL(window.location.href);
                    if (active) {
                        url.searchParams.set('simple', '1');
                    } else {
                        url.searchParams.delete('simple');
                    }
                    window.history.replaceState({}, '', url);
                    console.log(`[StatsView] å·²åŒæ­¥æ›´æ–°ç¶²å€åƒæ•¸: simple=${active ? '1' : '0'}`);
                } catch (e) {
                    console.warn('[StatsView] ç„¡æ³•æ›´æ–°ç¶²å€åƒæ•¸ (å¯èƒ½æ˜¯åœ¨ file:// ä¸‹åŸ·è¡Œ):', e);
                }
            }

            /**
             * åˆ‡æ›çµ±è¨ˆæ‘˜è¦ç°¡æ˜“é¡¯ç¤ºæ¨¡å¼
             */
            function toggleSimpleStatsMode() {
                const statsGrid = document.querySelector('#popout-content .stats-grid');
                if (!statsGrid) return;

                const isCurrentlySimple = statsGrid.classList.contains('stats-simple-mode');
                setSimpleStatsMode(!isCurrentlySimple);
            }

            /**
             * åˆå§‹åŒ–çµ±è¨ˆæ‘˜è¦é¡¯ç¤ºæ¨¡å¼
             */
            function initStatsDisplayMode() {
                const mode = localStorage.getItem('statsDisplayMode');
                const btn = document.getElementById('toggle-simple-stats-btn');

                if (btn && mode === 'simple') {
                    setSimpleStatsMode(true);
                }
            }

            /**
             * é¡¯ç¤º/éš±è—ç°¡æ˜“é¡¯ç¤ºæŒ‰éˆ•ï¼ˆåƒ…çµ±è¨ˆæ‘˜è¦é é¢é¡¯ç¤ºï¼‰
             */
            function updateSimpleStatsButton(blockId) {
                const btn = document.getElementById('toggle-simple-stats-btn');
                if (!btn) return;

                if (blockId === 'stats-grid-wrapper') {
                    btn.style.display = 'inline-flex';
                    // ç¶å®šé»æ“Šäº‹ä»¶
                    btn.onclick = toggleSimpleStatsMode;
                    // åˆå§‹åŒ–é¡¯ç¤ºæ¨¡å¼
                    setTimeout(initStatsDisplayMode, 100);
                } else {
                    btn.style.display = 'none';
                }
            }

            /**
             * è™•ç†èª¿æ•´å¯¬åº¦ç§»å‹•ï¼ˆå½ˆå‡ºè¦–çª—ï¼‰
             */
            function handlePopoutResizeMove(e) {
                if (!currentResizerField) return;
                const diff = e.pageX - startX;
                const newWidth = Math.max(50, startWidth + diff);

                // å„²å­˜å¯¬åº¦è¨­å®š
                const settings = DataManager.getColumnSettings() || { visible: {}, widths: {} };
                if (!settings.widths) settings.widths = {};
                settings.widths[currentResizerField] = `${newWidth}px`;
                DataManager.saveColumnSettings(settings);

                // å³æ™‚æ›´æ–°è©²æ¬„ä½å¯¬åº¦
                const ths = document.querySelectorAll(`th[data-col="${currentResizerField}"]`);
                const tds = document.querySelectorAll(`#search-results-table tbody tr`);

                ths.forEach(th => th.style.width = `${newWidth}px`);

                // æ›´æ–°å°æ‡‰çš„ td å¯¬åº¦
                const thIndex = Array.from(ths[0]?.parentElement.children || []).indexOf(ths[0]);
                if (thIndex >= 0) {
                    tds.forEach(tr => {
                        const td = tr.children[thIndex];
                        if (td) td.style.width = `${newWidth}px`;
                    });
                }

                // å»£æ’­å¯¬åº¦è®Šæ›´ï¼ˆåŒæ­¥åˆ°ä¸»é é¢ï¼‰
                if (typeof SyncManager !== 'undefined') {
                    SyncManager.broadcast(SyncManager.EventTypes.SETTINGS_CHANGED, {
                        columnWidths: { [currentResizerField]: `${newWidth}px` }
                    });
                }
            }

            /**
             * åœæ­¢èª¿æ•´å¯¬åº¦ï¼ˆå½ˆå‡ºè¦–çª—ï¼‰
             */
            function stopPopoutResize() {
                document.body.classList.remove('resizing');
                document.removeEventListener('mousemove', handlePopoutResizeMove);
                document.removeEventListener('mouseup', stopPopoutResize);
                currentResizerField = null;
            }

            /**
             * HTML è½‰ç¾©
             */
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // åˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>

</html>